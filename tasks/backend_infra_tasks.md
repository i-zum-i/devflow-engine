# バックエンド・インフラ タスク一覧

## 概要

本ドキュメントは「DevFlow Engine」のバックエンドおよびインフラストラクチャ構築に関するタスクを一覧化したものです。
各タスクは担当者が作業内容を明確に理解できるよう、詳細に記述されています。

**凡例:**
- **先行タスク:** このタスクを開始する前に完了している必要があるタスク
- **並行作業:** 他のタスクと並行して進めることが可能なタスク
- **完了フラグ:** `[ ]` 未完了, `[x]` 完了

---

## I. インフラストラクチャ構築 (AWS CDK)

### フェーズ1: 基盤構築

| # | タスク名 | 詳細 | 担当者 | 先行タスク | 状態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **I-1** | **CDKプロジェクト初期化** | ・`cdk init app --language typescript` を実行<br>・`package.json`に必要なCDKライブラリを追加 | | (なし) | `[ ]` |
| **I-2** | **VPCネットワーク構築** | ・VPC、パブリック/プライベートサブネット、NAT Gatewayを定義<br>・`cdk.json`にVPC設定を記述 | | I-1 | `[ ]` |
| **I-3** | **基本IAMロール作成** | ・Lambda関数用の実行ロール<br>・ECSタスク用のタスクロールと実行ロール<br>・最小権限の原則に従う | | I-1 | `[ ]` |
| **I-4** | **Secrets Manager設定** | ・`devflow/github-app`シークレットを定義<br>・`devflow/claude-api-key`シークレットを定義<br>・CDKから参照できるようにする | | I-1 | `[ ]` |

### フェーズ2: コアサービス構築 (並行作業可能)

| # | タスク名 | 詳細 | 担当者 | 先行タスク | 状態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **I-5** | **DynamoDBテーブル作成** | ・`devflow-sessions`テーブルをCDKで定義<br>・パーティションキー: `session_id`<br>・TTL属性: `ttl`<br>・GSI: `user_id-created_at-index` | | I-2, I-3 | `[ ]` |
| **I-6** | **ECRリポジトリ作成** | ・`devflow-code-server`という名前のECRリポジトリをCDKで定義 | | I-2, I-3 | `[ ]` |
| **I-7** | **S3 & CloudFront設定** | ・フロントエンドの静的ファイルホスティング用S3バケットを作成<br>・S3をオリジンとするCloudFrontディストリビューションを作成 | | I-2 | `[ ]` |

### フェーズ3: コンピュートリソース構築

| # | タスク名 | 詳細 | 担当者 | 先行タスク | 状態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **I-8** | **ECSクラスタとタスク定義** | ・Fargate用のECSクラスタを作成<br>・`code-server`用のタスク定義を作成 (CPU, Memory, IAMロール)<br>・コンテナイメージ名はI-6で作成したECRリポジトリを指定 | | I-2, I-3, I-6 | `[ ]` |
| **I-9** | **API GatewayとLambda** | ・REST APIを作成<br>・各エンドポイント (`/sessions`, `/health`等) を定義<br>・各エンドポイントに対応するLambda関数リソースを定義 (コードはまだ空でOK) | | I-2, I-3, I-5 | `[ ]` |
| **I-10**| **Fargateサービス設定** | ・ECSタスクをオンデマンドで実行するためのサービスを定義<br>・開発環境用にFargate Spotを利用する設定を追加 | | I-8 | `[ ]` |

### フェーズ4: CI/CDと運用

| # | タスク名 | 詳細 | 担当者 | 先行タスク | 状態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **I-11**| **GitHub Actions (バックエンド)** | ・`main`ブランチへのpushをトリガー<br>・pytest実行 → CDKデプロイ のワークフローを作成 | | I-9, B-5 | `[ ]` |
| **I-12**| **GitHub Actions (コンテナ)** | ・`container`ディレクトリの変更をトリガー<br>・Dockerビルド → ECRプッシュ のワークフローを作成 | | I-6, B-2 | `[ ]` |
| **I-13**| **監視とアラート設定** | ・CloudWatchダッシュボードをCDKで定義<br>・Lambdaエラー率、ECSタスク失敗のアラートを作成 | | I-9, I-10 | `[ ]` |

---

## II. バックエンド開発 (Python)

### フェーズ1: プロジェクト基盤構築

| # | タスク名 | 詳細 | 担当者 | 先行タスク | 状態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **B-1** | **Pythonプロジェクト設定** | ・`backend`ディレクトリ作成<br>・`requirements.txt` にFastAPI, Boto3, Pydantic等を記述<br>・`pytest`とテスト用ディレクトリ構造のセットアップ | | (なし) | `[ ]` |
| **B-2** | **コンテナ実装** | ・`container`ディレクトリ作成<br>・`Dockerfile`を作成 (設計書通り)<br>・`entrypoint.sh`と`ai-workflow.sh`を作成<br>・ローカルで`docker build`が成功することを確認 | | (なし) | `[ ]` |

### フェーズ2: 共通モジュール開発 (並行作業可能)

| # | タスク名 | 詳細 | 担当者 | 先行タスク | 状態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **B-3** | **共通処理モジュール実装** | ・`lambda_utils.py`: APIレスポンス整形、エラーハンドリングクラス<br>・`models.py`: Pydanticモデル定義 | | B-1 | `[ ]` |
| **B-4** | **外部サービスクライアント実装** | ・`github_client.py`: GitHub App認証、APIコール<br>・`ecs_client.py`: ECSタスクの実行・停止ラッパー | | B-1 | `[ ]` |

### フェーズ3: API実装

| # | タスク名 | 詳細 | 担当者 | 先行タスク | 状態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **B-5** | **セッション開始API実装** | ・`start_session` Lambda関数の実装<br>・リクエスト検証、GitHub App認証、ECSタスク起動、DynamoDB書き込み | | B-3, B-4, I-5, I-8 | `[ ]` |
| **B-6** | **ステータス取得API実装** | ・`get_status` Lambda関数の実装<br>・DynamoDBからセッション情報を取得して返す | | B-3, I-5 | `[ ]` |
| **B-7** | **プロンプト実行API実装** | ・`execute_prompt` Lambda関数の実装<br>・(TODO: 詳細設計にはないが、コンテナ内のプロセスと通信する方法を確立する必要がある。例: SQS, EventBridge) | | B-3, I-5 | `[ ]` |
| **B-8** | **セッション停止API実装** | ・`stop_session` Lambda関数の実装<br>・ECSタスクを停止し、DynamoDBのステータスを更新する | | B-4, I-5, I-8 | `[ ]` |
| **B-9** | **その他API実装** | ・`get_editor_url`, `health_check` 等、残りのAPIを実装 | | B-3, B-4 | `[ ]` |

### フェーズ4: テストとデプロイ

| # | タスク名 | 詳細 | 担当者 | 先行タスク | 状態 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **B-10**| **単体テスト実装** | ・`pytest`と`unittest.mock`を使用<br>・共通モジュール、各Lambdaハンドラのロジックをテスト | | B-3, B-4, B-5-9 | `[ ]` |
| **B-11**| **結合テスト** | ・実際にCDKでデプロイした環境に対し、APIテストを実施<br>・`start_session`から`stop_session`までの一連の流れを確認 | | I-11, B-10 | `[ ]` |
